// assembly-line
// ----------------------------------
// v0.0.2
//
// Copyright (c)2015 Mauro Trigo, CityHeroes.
// Distributed under MIT license

(function(t,e){"use strict";if("function"==typeof define&&define.amd)define(["underscore","moment"],function(a,i){return t.AssemblyLine=e(t,a,i)});else if("undefined"!=typeof exports){var a=require("underscore"),i=require("moment");module.exports=e(t,a,i)}else t.AssemblyLine=e(t,t._,t.moment)})(this,function(t,e,a){"use strict";var i=function(t,e){return e.split(".").reduce(function(t,e){return t?t[e]:null},t)},r={defaultValue:"",timey:!1,displayDateFormat:"DD/MM/YYYY",displayTimeFormat:"HH:mm:ss",displayDatetimeFormat:"DD/MM/YYYY HH:mm:ss"},n=function(t){this.settings=t||{},e.defaults(this.settings,r)};return n.prototype.process=function(t,a){return e.isArray(t)||(t=[t]),a=a||{},a.filters&&a.filters.length>0&&(t=this._applyFilters(a.filters,t)),a.transformations&&a.transformations.length>0&&(t=this._applyTransformations(a.transformations,t)),a.aggregations&&a.aggregations.length>0&&(t=e.map(a.aggregations,this._applyAggregation,{dataCollection:t})),t},n.prototype._applyFilters=function(t,a){var i=this;return e.each(t,function(t){a=i._applyFilter(t,a)}),e(a).flatten()},n.prototype._applyFilter=function(t,a){return e.filter(a,function(e){var a=i(e,t.path);return a?""+a==""+t.match:!1})},n.prototype._applyTransformations=function(t,a){var i=this,r=e.map(a,function(a){var r={};return e.each(t,function(t){r[t.name]=i._applyTransformation(t,a)}),r});return r},n.prototype._applyTransformation=function(t,r){var n=i(r,t.path)||this.settings.defaultValue;if(!t.operation)return n;switch(t.operation){case"concat":n=e.reduce(e.rest(t.params),function(t,e){return t+" "+i(r,e)},i(r,e.first(t.params)));break;case"date":n!==this.settings.defaultValue&&(n=a(n,this.settings.inputDateFormat).format(this.settings.displayDateFormat));break;case"time":n!==this.settings.defaultValue&&(n=a(n,this.settings.inputDateFormat).format(this.settings.displayTimeFormat));break;case"datetime":n!==this.settings.defaultValue&&(n=a(n,this.settings.inputDateFormat).format(this.settings.displayDatetimeFormat));break;case"timey":n=this.settings.timey?n.substring(0,13)+":00:00":n.substring(0,10);break;case"pick":n=e.map(t.params,function(t){return i(r,t)});break;default:return n}return n},n.prototype._applyAggregation=function(t){if(t.explicit_value)return t.explicit_value;var a=0;switch(t.type){case"count":a=e.size(this.dataCollection);break;case"sum":a=e.reduce(this.dataCollection,function(e,a){return i(a,t.path)+e},0);break;case"multiply":a=e.reduce(this.dataCollection,function(e,a){return i(a,t.path)*e},1)}return a},n});
//@ sourceMappingURL=assembly-line.min.map