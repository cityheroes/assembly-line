// assembly-line
// ----------------------------------
// v1.0.0
//
// Copyright (c)2017 Mauro Trigo, CityHeroes.
// Distributed under MIT license

(function(t,e){"use strict";if("function"==typeof define&&define.amd)define(["underscore","moment"],function(r,a){return t.AssemblyLine=e(t,r,a)});else if("undefined"!=typeof exports){var r=require("underscore"),a=require("moment");module.exports=e(t,r,a)}else t.AssemblyLine=e(t,t._,t.moment)})(this,function(t,e,r){"use strict";var a=function(t,e){return e.split(".").reduce(function(t,e){return t?t[e]:null},t)},n={defaultValue:"",timey:!1,inputDateFormat:"YYYY-MM-DD HH:mm:ss",displayDateFormat:"L",displayTimeFormat:"HH:mm:ss",displayDatetimeFormat:"L HH:mm:ss",outputLocalTime:!0,overturnParentAttributeName:"vlmParent"},i=function(t){this.settings=t||{},e.defaults(this.settings,n)};i.prototype.setOption=function(t,e){this.settings[t]=e};var s={append:function(t,e,r){return t[r]=e,t},merge:function(t,r,a){var n=e.chain(r).keys().reduce(function(t,e){return t[a+e]=r[e],t},{}).value();return e.extend({},t,n)}};return i.getIt=a,i.prototype._process=function(t,r){return r.filters&&r.filters.length>0&&(t=this._applyFilters(r.filters,t)),r.overturn&&(t=this._applyOverturn(r.overturn,t)),r.transformations&&r.transformations.length>0&&(t=this._applyTransformations(r.transformations,t)),r.addedTransformations&&r.addedTransformations.length>0&&(t=this._applyAddedTransformations(r.addedTransformations,t)),r.aggregations&&r.aggregations.length>0&&(t=e.map(r.aggregations,this._applyAggregation,{dataCollection:t})),r.transposition&&r.transposition.pivot&&(t=this._applyTransposition(r.transposition,t)),t},i.prototype.process=function(t,r){if(e.isArray(t)||(t=[t]),r=r||{},e.isArray(r)){var a=this;e.each(r,function(e){t=a._process(t,e)})}else t=this._process(t,r);return t},i.prototype._applyFilters=function(t,r){var a=this;return e.each(t,function(t){r=a._applyFilter(t,r)}),e(r).flatten()},i.prototype._applyFilter=function(t,r){return e.filter(r,function(e){var r=a(e,t.path);return r?""+r==""+t.match:!1})},i.prototype._applyTransformations=function(t,r){var a=this,n=e.map(r,function(r){var n={};return e.each(t,function(t){n[t.name]=a._applyTransformation(t,r)}),n});return n},i.prototype._applyAddedTransformations=function(t,r){var a=this,n=e.map(r,function(r){var n=r;return e.each(t,function(t){n[t.name]=a._applyTransformation(t,r)}),n});return n},i.prototype._applyOverturn=function(t,r){var a=r,n=this;return e.map(Array.isArray(t)?t:[t],function(t){if(!t.pivot)return console.error("An pivot must be specified in order to apply overturn operation"),void 0;var r=t.pivot,i=t.mode||n.settings.overturnMode,o="merge"==i&&""===t.parentAttributeName?"":t.parentAttributeName||n.settings.overturnParentAttributeName,p=s[i];a=e.reduce(a,function(t,a){var n=e.omit(a,r);if(Array.isArray(a[r])){var i=e.map(a[r],function(t){return p(t,n,o)});t=t.concat(i)}else if(a[r]){var s=a[r];t.push(p(s,n,o))}return t},[])}),a},i.prototype._parseDatetime=function(t){var e=r.utc(t,this.settings.inputDateFormat);return this.settings.outputLocalTime&&e.local(),e},i.prototype._applyTransformation=function(t,r){var n=a(r,t.path)!==void 0?a(r,t.path):this.settings.defaultValue;if(!t.operation)return n;switch(t.operation){case"concat":n=e.reduce(e.rest(t.params),function(t,e){return t+" "+a(r,e)},a(r,e.first(t.params)));break;case"truncate":var i=t.params&&t.params[0]?t.params[0]:100;n=n.substring(0,i);break;case"date":n!==this.settings.defaultValue&&(n=this._parseDatetime(n).format(this.settings.displayDateFormat));break;case"time":n!==this.settings.defaultValue&&(n=this._parseDatetime(n).format(this.settings.displayTimeFormat));break;case"datetime":n!==this.settings.defaultValue&&(n=this._parseDatetime(n).format(this.settings.displayDatetimeFormat));break;case"timey":n=this.settings.timey?n.substring(0,13)+":00:00":n.substring(0,10),n=this._parseDatetime(n).format(this.settings.inputDateFormat);break;case"pick":n=e.map(t.params,function(t){return a(r,t)});break;case"sum":n=e.reduce(t.params,function(t,e){var n=a(r,e)||0;return t+n},0);break;case"exclusiveSum":n=e.reduce(e.values(e.omit(r,t.params)),function(t,e){return e=Number(e),t+e},0);break;case"lowercase":n!==this.settings.defaultValue&&"string"==typeof n&&(n=n.toLocaleLowerCase());break;case"upercase":n!==this.settings.defaultValue&&"string"==typeof n&&(n=n.toLocaleUpperCase());break;case"decimal":if(n!==this.settings.defaultValue){var s=t.params&&t.params[0]!==void 0?parseInt(t.params[0]):2;n=parseFloat(n).toFixed(s)}break;default:return n}return n},i.prototype._applyAggregation=function(t){if(t.explicit_value)return t.explicit_value;var r=0;switch(t.type){case"count":r=e.size(this.dataCollection);break;case"sum":r=e.reduce(this.dataCollection,function(e,r){return a(r,t.path)+e},0);break;case"multiply":r=e.reduce(this.dataCollection,function(e,r){return a(r,t.path)*e},1)}return r},i.prototype._applyTransposition=function(t,r){var a=t.pivot,n=t.name,i=e.map(r,function(t){var r=[e.flatten(e.pairs(e.pick(t,a))),e.pairs(e.omit(t,a))];return r});i=e.zip.apply(this,i);var s=e.map(i[0],function(t){return[n,t[1]]});return i=e.zip.apply(this,i[1]),i=e.map(i,function(t){var r=e.zip(s,t);r=e.map(r,function(t){return e.object(e.zip.apply(this,t))});var a=[{}];return a=a.concat(r),e.extend.apply(this,a)})},i});
//@ sourceMappingURL=assembly-line.min.map