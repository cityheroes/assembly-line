// assembly-line
// ----------------------------------
// v0.0.8
//
// Copyright (c)2017 Mauro Trigo, CityHeroes.
// Distributed under MIT license

(function(t,e){"use strict";if("function"==typeof define&&define.amd)define(["underscore","moment"],function(a,r){return t.AssemblyLine=e(t,a,r)});else if("undefined"!=typeof exports){var a=require("underscore"),r=require("moment");module.exports=e(t,a,r)}else t.AssemblyLine=e(t,t._,t.moment)})(this,function(t,e,a){"use strict";var r=function(t,e){return e.split(".").reduce(function(t,e){return t?t[e]:null},t)},i={defaultValue:"",timey:!1,inputDateFormat:"YYYY-MM-DD HH:mm:ss",displayDateFormat:"L",displayTimeFormat:"HH:mm:ss",displayDatetimeFormat:"L HH:mm:ss",outputLocalTime:!0,overturnParentName:"vlmParent"},n=function(t){this.settings=t||{},e.defaults(this.settings,i)};return n.getIt=r,n.prototype.process=function(t,a){return e.isArray(t)||(t=[t]),a=a||{},a.filters&&a.filters.length>0&&(t=this._applyFilters(a.filters,t)),a.overturn&&(a.overturn.attribute?t=this._applyOverturn(a.overturn,t):console.error("An attribute must be specified in order to apply overturn operation")),a.transformations&&a.transformations.length>0&&(t=this._applyTransformations(a.transformations,t)),a.aggregations&&a.aggregations.length>0&&(t=e.map(a.aggregations,this._applyAggregation,{dataCollection:t})),a.transposition&&a.transposition.pivot&&(t=this._applyTransposition(a.transposition,t)),t},n.prototype._applyFilters=function(t,a){var r=this;return e.each(t,function(t){a=r._applyFilter(t,a)}),e(a).flatten()},n.prototype._applyFilter=function(t,a){return e.filter(a,function(e){var a=r(e,t.path);return a?""+a==""+t.match:!1})},n.prototype._applyTransformations=function(t,a){var r=this,i=e.map(a,function(a){var i={};return e.each(t,function(t){i[t.name]=r._applyTransformation(t,a)}),i});return i},n.prototype._applyOverturn=function(t,a){var r=t.attribute,i=t.overturnParentName||this.settings.overturnParentName,n=e.reduce(a,function(t,a){var n=e.omit(a,r);if(Array.isArray(a[r])){var s=e.map(a[r],function(t){return t[i]=n,t});t=t.concat(s)}else if(a[r]){var o=a[r];o[i]=n,t.push(o)}return t},[]);return n},n.prototype._parseDatetime=function(t){var e=a.utc(t,this.settings.inputDateFormat);return this.settings.outputLocalTime&&e.local(),e},n.prototype._applyTransformation=function(t,a){var i=r(a,t.path)!==void 0?r(a,t.path):this.settings.defaultValue;if(!t.operation)return i;switch(t.operation){case"concat":i=e.reduce(e.rest(t.params),function(t,e){return t+" "+r(a,e)},r(a,e.first(t.params)));break;case"truncate":var n=t.params&&t.params[0]?t.params[0]:100;i=i.substring(0,n);break;case"date":i!==this.settings.defaultValue&&(i=this._parseDatetime(i).format(this.settings.displayDateFormat));break;case"time":i!==this.settings.defaultValue&&(i=this._parseDatetime(i).format(this.settings.displayTimeFormat));break;case"datetime":i!==this.settings.defaultValue&&(i=this._parseDatetime(i).format(this.settings.displayDatetimeFormat));break;case"timey":i=this.settings.timey?i.substring(0,13)+":00:00":i.substring(0,10),i=this._parseDatetime(i).format(this.settings.inputDateFormat);break;case"pick":i=e.map(t.params,function(t){return r(a,t)});break;case"lowercase":i!==this.settings.defaultValue&&"string"==typeof i&&(i=i.toLocaleLowerCase());break;case"upercase":i!==this.settings.defaultValue&&"string"==typeof i&&(i=i.toLocaleUpperCase());break;case"decimal":if(i!==this.settings.defaultValue){var s=t.params&&t.params[0]!==void 0?parseInt(t.params[0]):2;i=parseFloat(i).toFixed(s)}break;default:return i}return i},n.prototype._applyAggregation=function(t){if(t.explicit_value)return t.explicit_value;var a=0;switch(t.type){case"count":a=e.size(this.dataCollection);break;case"sum":a=e.reduce(this.dataCollection,function(e,a){return r(a,t.path)+e},0);break;case"multiply":a=e.reduce(this.dataCollection,function(e,a){return r(a,t.path)*e},1)}return a},n.prototype._applyTransposition=function(t,a){var r=t.pivot,i=t.name,n=e.map(a,function(t){var a=[e.flatten(e.pairs(e.pick(t,r))),e.pairs(e.omit(t,r))];return a});n=e.zip.apply(this,n);var s=e.map(n[0],function(t){return[i,t[1]]});return n=e.zip.apply(this,n[1]),n=e.map(n,function(t){var a=e.zip(s,t);a=e.map(a,function(t){return e.object(e.zip.apply(this,t))});var r=[{}];return r=r.concat(a),e.extend.apply(this,r)})},n});
//@ sourceMappingURL=assembly-line.min.map